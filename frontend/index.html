<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lead Enrichment Dashboard</title>
  <style>
    /* =========================
       PRO DASHBOARD THEME
    ========================== */
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --muted: #64748b;
      --text: #0f172a;
      --border: #e5e7eb;
      --primary: #4f46e5;
      --primary-2: #7c3aed;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      --shadow-sm: 0 6px 18px rgba(15, 23, 42, 0.08);
      --ring: 0 0 0 3px rgba(79, 70, 229, 0.18);
      --ok: #16a34a;
      --bad: #dc2626;
      --warn: #f59e0b;
      --info: #2563eb;
      --tableHead: #111827;
      --tableHeadText: #fff;
      --rowHover: #f8fafc;
    }

    [data-theme="dark"]{
      --bg: #0b1220;
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --border: #22304a;
      --shadow: 0 12px 36px rgba(0,0,0,.45);
      --shadow-sm: 0 8px 20px rgba(0,0,0,.35);
      --rowHover: #0b1a33;
      --tableHead: #0b1220;
      --tableHeadText: #e5e7eb;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(79,70,229,.14), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(124,58,237,.10), transparent 60%),
                  var(--bg);
      color: var(--text);
    }

    a { color: var(--primary); text-decoration: none; font-weight: 600; }
    a:hover { text-decoration: underline; }

    .container{
      max-width: 1280px;
      margin: 0 auto;
      padding: 18px;
    }

    /* =========================
       HEADER (compact + sticky)
    ========================== */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(to bottom, rgba(246,247,251,.95), rgba(246,247,251,.80));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    [data-theme="dark"] .topbar{
      background: linear-gradient(to bottom, rgba(11,18,32,.92), rgba(11,18,32,.78));
    }

    .topbar-inner{
      max-width: 1280px;
      margin: 0 auto;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand{
      display: flex;
      gap: 12px;
      align-items: center;
      min-width: 220px;
    }
    .logo{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      box-shadow: 0 10px 24px rgba(79,70,229,.25);
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 900;
      letter-spacing: .5px;
    }
    .brand h1{
      margin: 0;
      font-size: 16px;
      line-height: 1.1;
    }
    .brand p{
      margin: 2px 0 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .top-actions{
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn{
      border: 1px solid transparent;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      box-shadow: 0 10px 24px rgba(79,70,229,.20);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      transition: transform .08s ease, opacity .2s ease;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:disabled{ opacity: .6; cursor: not-allowed; transform: none; }

    .btn.secondary{
      background: transparent;
      border-color: var(--border);
      color: var(--text);
      box-shadow: none;
    }
    .btn.danger{
      background: linear-gradient(135deg, #ef4444, #dc2626);
      box-shadow: 0 10px 24px rgba(220,38,38,.18);
    }

    .icon-btn{
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      display: grid;
      place-items: center;
      box-shadow: var(--shadow-sm);
    }
    .icon-btn:hover{ outline: none; box-shadow: var(--shadow-sm), var(--ring); }

    /* =========================
       CARDS / SECTIONS
    ========================== */
    .grid{
      display: grid;
      gap: 14px;
    }

    .stats{
      grid-template-columns: repeat(6, minmax(0,1fr));
      margin-top: 14px;
    }
    @media (max-width: 1100px){ .stats{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width: 640px){ .stats{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow-sm);
      padding: 14px;
    }

    .stat{
      padding: 14px;
    }
    .stat .label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .07em;
    }
    .stat .value{
      margin-top: 8px;
      font-size: 26px;
      font-weight: 900;
    }
    .stat .sub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .progress-wrap{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .progress-title{
      font-weight: 900;
      font-size: 14px;
    }
    .progress-meta{
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
    }
    .progress-bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(100,116,139,.20);
      overflow: hidden;
    }
    .progress-fill{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      transition: width .25s ease;
    }

    /* =========================
       UPLOAD (collapsible + compact)
    ========================== */
    .upload-head{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      cursor: pointer;
      user-select: none;
    }
    .upload-head .left{
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .pill{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      font-weight: 800;
      background: rgba(100,116,139,.06);
    }
    .chev{
      font-weight: 900;
      color: var(--muted);
      padding: 4px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(100,116,139,.06);
    }

    .upload-body{
      margin-top: 12px;
      display: none;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .upload-body.open{ display: flex; }

    .file{
      flex: 1;
      min-width: 220px;
      padding: 10px 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: rgba(100,116,139,.05);
      color: var(--text);
      font-weight: 700;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      width: 100%;
      margin-top: -2px;
    }

    /* =========================
       CONTROLS (sticky inside page)
    ========================== */
    .controls{
      position: sticky;
      top: 74px; /* below topbar */
      z-index: 40;
      background: linear-gradient(to bottom, rgba(246,247,251,.96), rgba(246,247,251,.86));
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
    }
    [data-theme="dark"] .controls{
      background: linear-gradient(to bottom, rgba(11,18,32,.94), rgba(11,18,32,.80));
    }

    .controls .row{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .input{
      flex: 1;
      min-width: 240px;
      padding: 10px 12px 10px 36px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(100,116,139,.06);
      color: var(--text);
      font-weight: 700;
      outline: none;
    }
    .input:focus{ box-shadow: var(--ring); border-color: rgba(79,70,229,.35); }
    .search-wrap{ position: relative; flex: 1; min-width: 240px; }
    .search-ico{ position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 14px; }

    select{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(100,116,139,.06);
      color: var(--text);
      font-weight: 800;
      outline: none;
    }
    select:focus{ box-shadow: var(--ring); border-color: rgba(79,70,229,.35); }

    .controls .actions{
      margin-left: auto;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* =========================
       TABLE AREA (fixed height + scroll)
    ========================== */
    .table-card{
      padding: 0;
      overflow: hidden;
    }
    .table-head{
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .table-head .title{
      font-weight: 900;
      font-size: 14px;
    }
    .table-head .meta{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }

    .table-wrap{
      height: 62vh;             /* ‚úÖ keeps page short */
      overflow: auto;           /* ‚úÖ only table scrolls */
      background: var(--card);
    }

    table{
      width: 100%;
      border-collapse: collapse;
      min-width: 980px;
    }
    thead th{
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--tableHead);
      color: var(--tableHeadText);
      text-align: left;
      font-size: 11px;
      letter-spacing: .07em;
      text-transform: uppercase;
      padding: 12px;
    }
    tbody td{
      border-bottom: 1px solid var(--border);
      padding: 11px 12px;
      vertical-align: top;
      font-size: 13px;
    }
    tbody tr:hover{ background: var(--rowHover); }
    .company{
      font-weight: 900;
      line-height: 1.25;
    }
    .muted{ color: var(--muted); font-weight: 700; font-size: 12px; margin-top: 3px; }
    .mini{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }

    /* badges */
    .badge{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .04em;
      border: 1px solid transparent;
      white-space: nowrap;
    }
    .b-pending{ background: rgba(245,158,11,.12); color: var(--warn); border-color: rgba(245,158,11,.25); }
    .b-processing{ background: rgba(37,99,235,.12); color: var(--info); border-color: rgba(37,99,235,.25); }
    .b-done{ background: rgba(22,163,74,.12); color: var(--ok); border-color: rgba(22,163,74,.25); }
    .b-error{ background: rgba(220,38,38,.12); color: var(--bad); border-color: rgba(220,38,38,.25); }

    .valid-ok{ color: var(--ok); font-weight: 900; }
    .valid-bad{ color: var(--bad); font-weight: 900; }

    .quality{
      font-weight: 900;
    }
    .qbar{
      height: 8px;
      border-radius: 999px;
      background: rgba(100,116,139,.20);
      overflow: hidden;
      margin-top: 6px;
    }
    .qfill{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
    }

    .row-actions{
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .tiny-btn{
      border: 1px solid var(--border);
      background: rgba(100,116,139,.06);
      color: var(--text);
      border-radius: 10px;
      padding: 7px 9px;
      font-weight: 900;
      cursor: pointer;
    }
    .tiny-btn:hover{ box-shadow: var(--ring); }
    .tiny-btn.danger{ border-color: rgba(220,38,38,.35); color: #ef4444; }
    .tiny-btn.primary{ border-color: rgba(79,70,229,.35); color: var(--primary); }

    /* =========================
       PAGINATION
    ========================== */
    .pager{
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      background: rgba(100,116,139,.04);
      flex-wrap: wrap;
    }
    .pager .info{
      margin-right: auto;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }
    .pager select{ padding: 8px 10px; }

    /* =========================
       TOASTS
    ========================== */
    .toasts{
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    .toast{
      pointer-events: auto;
      min-width: 280px;
      max-width: 360px;
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-left: 6px solid var(--primary);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 12px 12px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
      animation: slideIn .18s ease;
    }
    @keyframes slideIn{
      from{ transform: translateX(30px); opacity: 0; }
      to{ transform: translateX(0); opacity: 1; }
    }
    .toast .ticon{ font-size: 18px; margin-top: 1px; }
    .toast .tmain{ flex: 1; }
    .toast .ttitle{ font-weight: 900; font-size: 13px; }
    .toast .tmsg{ color: var(--muted); font-weight: 700; font-size: 12px; margin-top: 3px; }
    .toast .tclose{
      border: 0;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-weight: 900;
      font-size: 16px;
      line-height: 1;
    }
    .toast.success{ border-left-color: var(--ok); }
    .toast.error{ border-left-color: var(--bad); }
    .toast.info{ border-left-color: var(--info); }

    /* =========================
       FLOATING BACK TO TOP
    ========================== */
    #backTop{
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      display: none;
      place-items: center;
      font-weight: 900;
      z-index: 60;
    }
    #backTop:hover{ box-shadow: var(--shadow-sm), var(--ring); }
  </style>
</head>

<body>
  <div class="toasts" id="toasts"></div>

  <!-- Sticky Top Bar -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">GM</div>
        <div>
          <h1>Lead Enrichment Dashboard</h1>
          <p>CSV upload ‚Üí background enrichment ‚Üí validated leads</p>
        </div>
      </div>

      <div class="top-actions">
        <button class="btn secondary" id="btnRefresh" onclick="refreshAll()">‚Üª Refresh</button>
        <button class="btn" onclick="downloadCsv()">‚¨á Export CSV</button>
        <button class="icon-btn" id="btnTheme" onclick="toggleTheme()" title="Toggle theme">üåô</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Stats -->
    <div class="grid stats" style="margin-top:14px;">
      <div class="card stat">
        <div class="label">Total</div>
        <div class="value" id="statTotal">0</div>
        <div class="sub">rows in database</div>
      </div>
      <div class="card stat">
        <div class="label">Done</div>
        <div class="value" id="statDone">0</div>
        <div class="sub">completed</div>
      </div>
      <div class="card stat">
        <div class="label">Processing</div>
        <div class="value" id="statProcessing">0</div>
        <div class="sub">in progress</div>
      </div>
      <div class="card stat">
        <div class="label">Pending</div>
        <div class="value" id="statPending">0</div>
        <div class="sub">queued</div>
      </div>
      <div class="card stat">
        <div class="label">Errors</div>
        <div class="value" id="statError">0</div>
        <div class="sub">failed</div>
      </div>
      <div class="card stat">
        <div class="label">Completion</div>
        <div class="value" id="statPercent">0%</div>
        <div class="sub">done / total</div>
      </div>
    </div>

    <!-- Progress -->
    <div class="card" style="margin-top:14px;">
      <div class="progress-wrap">
        <div class="progress-title">Enrichment Progress</div>
        <div class="progress-meta" id="progressMeta">0 / 0 (0%)</div>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    </div>

    <!-- Upload (collapsible) -->
    <div class="card" style="margin-top:14px;">
      <div class="upload-head" onclick="toggleUpload()">
        <div class="left">
          <div style="font-weight: 900;">Upload leads</div>
          <span class="pill">CSV / XLSX</span>
          <span class="pill" id="uploadState">ready</span>
        </div>
        <div class="chev" id="uploadChev">‚ñæ</div>
      </div>

      <div class="upload-body" id="uploadBody">
        <input class="file" type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
        <button class="btn" id="btnUpload" onclick="uploadFile()">‚¨Ü Upload & Enrich</button>
        <button class="btn secondary" onclick="clearFile()">‚úï Clear</button>
        <div class="hint" id="uploadHint">Tip: export from Instant Data Scraper then upload here for enrichment.</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="card controls" style="margin-top:14px;">
      <div class="row">
        <div class="search-wrap">
          <span class="search-ico">üîé</span>
          <input class="input" id="searchInput" placeholder="Search company, email, phone‚Ä¶" />
        </div>

        <select id="statusFilter" title="Status">
          <option value="all">Status: All</option>
          <option value="done">Status: Done</option>
          <option value="processing">Status: Processing</option>
          <option value="pending">Status: Pending</option>
          <option value="error">Status: Error</option>
        </select>

        <select id="validationFilter" title="Validation">
          <option value="all">Validation: All</option>
          <option value="OK">Validation: OK</option>
          <option value="Invalid">Validation: Invalid</option>
          <option value="None">Validation: None</option>
        </select>

        <div class="actions">
          <button class="btn secondary" onclick="retryFailed()">üîÑ Retry Failed</button>
          <button class="btn danger" onclick="clearAll()">üóë Clear All</button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card table-card" style="margin-top:14px;">
      <div class="table-head">
        <div class="title">Results</div>
        <div class="meta" id="tableMeta">Showing 0 rows</div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width: 32%;">Company</th>
              <th style="width: 12%;">Phone</th>
              <th style="width: 18%;">Email</th>
              <th style="width: 10%;">Website</th>
              <th style="width: 10%;">Status</th>
              <th style="width: 18%;">Validation</th>
              <th style="width: 10%;">Quality</th>
              <th style="width: 10%;">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="8" style="padding:16px;">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <div class="pager">
        <div class="info" id="pagerInfo">Page 1</div>
        <label class="mini">Rows/page</label>
        <select id="pageSize">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <button class="btn secondary" onclick="prevPage()">‚Üê Prev</button>
        <button class="btn secondary" onclick="nextPage()">Next ‚Üí</button>
      </div>
    </div>

    <div style="height: 20px;"></div>
  </div>

  <button id="backTop" onclick="scrollToTop()" title="Back to top">‚Üë</button>

  <script>
    /* =========================
       BACKEND ENDPOINTS
    ========================== */
    const API = {
      upload: "/upload-csv",
      companies: "/companies",
      progress: "/progress",
      exportCsv: "/export-csv",
      retryFailed: "/companies/retry-failed",
      retryOne: (id) => `/companies/${id}/retry`,
      deleteOne: (id) => `/companies/${id}`,
      clearAll: "/companies",
    };

    /* =========================
       STATE
    ========================== */
    let allCompanies = [];
    let filtered = [];
    let page = 1;
    let pageSize = 25;
    let pollTimer = null;

    /* =========================
       THEME
    ========================== */
    function setTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
      document.getElementById("btnTheme").textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
    }
    function toggleTheme(){
      const curr = document.documentElement.getAttribute("data-theme") || "light";
      setTheme(curr === "dark" ? "light" : "dark");
    }
    setTheme(localStorage.getItem("theme") || "light");

    /* =========================
       TOASTS
    ========================== */
    function toast(type, title, msg){
      const wrap = document.getElementById("toasts");
      const t = document.createElement("div");
      const icon = type === "success" ? "‚úÖ" : type === "error" ? "‚ùå" : "‚ÑπÔ∏è";
      t.className = `toast ${type}`;
      t.innerHTML = `
        <div class="ticon">${icon}</div>
        <div class="tmain">
          <div class="ttitle">${escapeHtml(title)}</div>
          <div class="tmsg">${escapeHtml(msg)}</div>
        </div>
        <button class="tclose" aria-label="close">‚úï</button>
      `;
      t.querySelector(".tclose").onclick = () => t.remove();
      wrap.appendChild(t);
      setTimeout(() => { t.style.opacity = "0"; setTimeout(() => t.remove(), 250); }, 4500);
    }

    /* =========================
       HELPERS
    ========================== */
    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[s]));
    }

    async function fetchJson(url, opts){
      const res = await fetch(url, opts);
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function calcQuality(c){
      let s = 0;
      if(c.phone) s += 33;
      if(c.email) s += 33;
      if(c.website) s += 34;
      return s;
    }

    function badgeForStatus(status){
      const s = (status || "pending").toLowerCase();
      if(s === "done") return `<span class="badge b-done">done</span>`;
      if(s === "processing") return `<span class="badge b-processing">processing</span>`;
      if(s === "error") return `<span class="badge b-error">error</span>`;
      return `<span class="badge b-pending">pending</span>`;
    }

    function prettyValidation(v){
      if(v === "OK") return `<span class="valid-ok">‚úì OK</span>`;
      if(v && v.trim()) return `<span class="valid-bad">${escapeHtml(v)}</span>`;
      return `<span class="mini">‚Äî</span>`;
    }

    /* =========================
       UPLOAD (compact + collapse)
    ========================== */
    function toggleUpload(){
      const body = document.getElementById("uploadBody");
      const chev = document.getElementById("uploadChev");
      const isOpen = body.classList.toggle("open");
      chev.textContent = isOpen ? "‚ñ¥" : "‚ñæ";
    }
    // start closed, click to open
    // toggleUpload(); // uncomment if you want it open by default

    function clearFile(){
      document.getElementById("fileInput").value = "";
      setUploadState("ready", "ready");
    }

    function setUploadState(label, mode){
      const el = document.getElementById("uploadState");
      el.textContent = label;
      el.style.borderColor = "var(--border)";
      el.style.color = "var(--muted)";
      if(mode === "working"){ el.style.borderColor = "rgba(37,99,235,.35)"; el.style.color = "var(--info)"; }
      if(mode === "ok"){ el.style.borderColor = "rgba(22,163,74,.35)"; el.style.color = "var(--ok)"; }
      if(mode === "bad"){ el.style.borderColor = "rgba(220,38,38,.35)"; el.style.color = "var(--bad)"; }
    }

    async function uploadFile(){
      const input = document.getElementById("fileInput");
      const btn = document.getElementById("btnUpload");
      const file = input.files && input.files[0];
      if(!file){
        toast("error","No file","Choose a CSV/XLSX file first.");
        return;
      }

      const ext = file.name.split(".").pop().toLowerCase();
      if(!["csv","xlsx","xls"].includes(ext)){
        toast("error","Invalid file","Upload CSV/XLSX/XLS only.");
        return;
      }

      btn.disabled = true;
      setUploadState("uploading‚Ä¶", "working");

      try{
        const fd = new FormData();
        fd.append("file", file);

        const data = await fetchJson(API.upload, { method: "POST", body: fd });
        toast("success","Uploaded", `Rows: ${data.rows}. Enrichment started.`);
        setUploadState("processing‚Ä¶", "working");

        await refreshAll();
        startPolling();
      }catch(e){
        toast("error","Upload failed", String(e.message || e));
        setUploadState("failed", "bad");
      }finally{
        btn.disabled = false;
        input.value = "";
      }
    }

    /* =========================
       LOAD DATA
    ========================== */
    async function loadProgress(){
      const p = await fetchJson(API.progress);
      document.getElementById("statTotal").textContent = p.total ?? 0;
      document.getElementById("statDone").textContent = p.done ?? 0;
      document.getElementById("statProcessing").textContent = p.processing ?? 0;
      document.getElementById("statPending").textContent = p.pending ?? 0;
      document.getElementById("statError").textContent = p.error ?? 0;
      document.getElementById("statPercent").textContent = `${p.percent ?? 0}%`;

      document.getElementById("progressMeta").textContent = `${p.done ?? 0} / ${p.total ?? 0} (${p.percent ?? 0}%)`;
      document.getElementById("progressFill").style.width = `${p.percent ?? 0}%`;

      if((p.processing ?? 0) === 0 && (p.pending ?? 0) === 0 && (p.total ?? 0) > 0){
        setUploadState("done", "ok");
      }
      return p;
    }

    async function loadCompanies(){
      allCompanies = await fetchJson(API.companies);
      applyFilters();
    }

    async function refreshAll(){
      try{
        await Promise.all([loadProgress(), loadCompanies()]);
      }catch(e){
        toast("error","Fetch error", "Backend not reachable. Open dashboard via /dashboard.");
      }
    }

    /* =========================
       POLLING
    ========================== */
    function startPolling(){
      if(pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(async () => {
        try{
          const p = await loadProgress();
          await loadCompanies();
          if((p.processing ?? 0) === 0 && (p.pending ?? 0) === 0){
            clearInterval(pollTimer);
            pollTimer = null;
            toast("success","Completed","Enrichment finished.");
            setUploadState("done", "ok");
          }
        }catch{
          // silent during server reload
        }
      }, 2000);
    }

    /* =========================
       FILTERS + SEARCH
    ========================== */
    const searchInput = document.getElementById("searchInput");
    const statusFilter = document.getElementById("statusFilter");
    const validationFilter = document.getElementById("validationFilter");

    searchInput.addEventListener("input", () => { page = 1; applyFilters(); });
    statusFilter.addEventListener("change", () => { page = 1; applyFilters(); });
    validationFilter.addEventListener("change", () => { page = 1; applyFilters(); });

    function applyFilters(){
      const term = (searchInput.value || "").toLowerCase().trim();
      const status = statusFilter.value;
      const val = validationFilter.value;

      filtered = allCompanies.filter(c => {
        const hay = `${c.name||""} ${c.email||""} ${c.phone||""}`.toLowerCase();
        if(term && !hay.includes(term)) return false;

        const st = (c.processing_status || "pending").toLowerCase();
        if(status !== "all" && st !== status) return false;

        const v = c.validation_status;
        if(val === "OK" && v !== "OK") return false;
        if(val === "Invalid" && (v === "OK" || v == null || v === "")) return false;
        if(val === "None" && !(v == null || v === "")) return false;

        return true;
      });

      renderTable();
    }

    /* =========================
       PAGINATION
    ========================== */
    const pageSizeSel = document.getElementById("pageSize");
    pageSizeSel.addEventListener("change", () => {
      pageSize = parseInt(pageSizeSel.value, 10) || 25;
      page = 1;
      renderTable();
    });

    function totalPages(){
      return Math.max(1, Math.ceil(filtered.length / pageSize));
    }
    function prevPage(){
      page = Math.max(1, page - 1);
      renderTable();
    }
    function nextPage(){
      page = Math.min(totalPages(), page + 1);
      renderTable();
    }

    /* =========================
       RENDER TABLE (scrollable)
    ========================== */
    function renderTable(){
      const tbody = document.getElementById("tbody");

      const tp = totalPages();
      if(page > tp) page = tp;

      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      const slice = filtered.slice(start, end);

      document.getElementById("tableMeta").textContent =
        `Showing ${slice.length} of ${filtered.length} (total in DB: ${allCompanies.length})`;

      document.getElementById("pagerInfo").textContent =
        `Page ${page} / ${tp}`;

      if(slice.length === 0){
        tbody.innerHTML = `<tr><td colspan="8" style="padding:16px;">No results match your filters.</td></tr>`;
        return;
      }

      tbody.innerHTML = slice.map(c => {
        const q = calcQuality(c);
        const website = c.website ? `<a href="${escapeHtml(c.website)}" target="_blank">Visit</a>` : `<span class="mini">‚Äî</span>`;
        const phone = c.phone ? escapeHtml(c.phone) : `<span class="mini">‚Äî</span>`;
        const email = c.email ? escapeHtml(c.email) : `<span class="mini">‚Äî</span>`;

        const statusBadge = badgeForStatus(c.processing_status);
        const validation = prettyValidation(c.validation_status);

        const qbar = `
          <div class="quality">${q}%</div>
          <div class="qbar"><div class="qfill" style="width:${q}%;"></div></div>
        `;

        const canRetry = (c.processing_status || "") === "error";
        const retryBtn = canRetry ? `<button class="tiny-btn primary" onclick="retryOne(${c.id})" title="Retry">‚Üª</button>` : ``;

        return `
          <tr>
            <td>
              <div class="company">${escapeHtml(c.name || "‚Äî")}</div>
              <div class="muted">
                ${escapeHtml(c.company_type || "")}
                ${c.rating ? ` ‚Ä¢ ‚≠ê ${escapeHtml(c.rating)}` : ``}
              </div>
            </td>
            <td>${phone}</td>
            <td>${email}</td>
            <td>${website}</td>
            <td>${statusBadge}</td>
            <td>${validation}</td>
            <td>${qbar}</td>
            <td>
              <div class="row-actions">
                ${retryBtn}
                <button class="tiny-btn danger" onclick="deleteOne(${c.id})" title="Delete">üóë</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");
    }

    /* =========================
       ACTIONS
    ========================== */
    function downloadCsv(){
      window.location.href = API.exportCsv;
    }

    async function retryOne(id){
      try{
        await fetchJson(API.retryOne(id), { method: "POST" });
        toast("success","Queued","Lead queued for retry.");
        await refreshAll();
        startPolling();
      }catch(e){
        toast("error","Retry failed", String(e.message || e));
      }
    }

    async function retryFailed(){
      if(!confirm("Retry all failed leads?")) return;
      try{
        const r = await fetchJson(API.retryFailed, { method: "POST" });
        toast("success","Queued", `Retry queued: ${r.count ?? 0} leads`);
        await refreshAll();
        startPolling();
      }catch(e){
        toast("error","Retry failed", String(e.message || e));
      }
    }

    async function deleteOne(id){
      if(!confirm("Delete this lead?")) return;
      try{
        await fetchJson(API.deleteOne(id), { method: "DELETE" });
        toast("success","Deleted","Lead removed.");
        await refreshAll();
      }catch(e){
        toast("error","Delete failed", String(e.message || e));
      }
    }

    async function clearAll(){
      if(!confirm("This will delete ALL leads. Continue?")) return;
      try{
        await fetchJson(API.clearAll, { method: "DELETE" });
        toast("success","Cleared","All leads deleted.");
        allCompanies = [];
        filtered = [];
        page = 1;
        renderTable();
        await loadProgress();
      }catch(e){
        toast("error","Clear failed", String(e.message || e));
      }
    }

    /* =========================
       BACK TO TOP BUTTON
    ========================== */
    const backTop = document.getElementById("backTop");
    window.addEventListener("scroll", () => {
      backTop.style.display = window.scrollY > 400 ? "grid" : "none";
    });
    function scrollToTop(){
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    /* =========================
       INIT
    ========================== */
    (async function init(){
      toast("info","Connected","Dashboard is running.");
      await refreshAll();

      // If work is ongoing, start polling
      try{
        const p = await loadProgress();
        if((p.processing ?? 0) > 0 || (p.pending ?? 0) > 0) startPolling();
      }catch{}
    })();
  </script>
</body>
</html>
